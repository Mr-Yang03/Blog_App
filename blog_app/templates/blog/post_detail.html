{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ post.title }} - Blog App{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/post_detail.css' %}">
{% endblock %}

{% block content %}
<article class="post-detail">
    <header class="post-header">
        {% if post.category %}
        <a href="{% url 'blog:category_posts' post.category.slug %}" class="category-badge">
            {{ post.category.name }}
        </a>
        {% endif %}
        <h1>{{ post.title }}</h1>
        <div class="post-meta">
            <span class="author">
                By <a href="{% url 'users:profile' post.author.username %}">{{ post.author.username }}</a>
            </span>
            <span class="date">{{ post.published_at|date:"F d, Y" }}</span>
            <span class="views">{{ post.views_count }} views</span>
            <span class="likes">{{ likes_count }} likes</span>
            <span class="comments-count">{{ comments_count }} comments</span>
        </div>
    </header>

    {% if post.featured_image %}
    <div class="post-image">
        <img src="{{ post.featured_image.url }}" alt="{{ post.title }}">
    </div>
    {% endif %}

    <div class="post-content">
        {{ post.content|linebreaks }}
    </div>

    <footer class="post-footer">
        <div class="post-tags">
            {% for tag in post.tags.all %}
            <a href="{% url 'blog:tag_posts' tag.slug %}" class="tag">{{ tag.name }}</a>
            {% endfor %}
        </div>

        <div class="post-actions">
            {% if user.is_authenticated %}
            <form method="post" action="{% url 'blog:toggle_like' post.slug %}" class="like-form">
                {% csrf_token %}
                <button type="submit" class="btn-like {% if user_liked %}liked{% endif %}">
                    {% if user_liked %}Unlike{% else %}Like{% endif %} ({{ likes_count }})
                </button>
            </form>
            {% else %}
            <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn-like">Login to Like</a>
            {% endif %}
        </div>
    </footer>
</article>

{% if related_posts %}
<section class="related-posts">
    <h2>Related Posts</h2>
    <div class="related-grid">
        {% for related in related_posts %}
        <article class="related-card">
            {% if related.featured_image %}
            <img src="{{ related.featured_image.url }}" alt="{{ related.title }}">
            {% else %}
            <img src="{% static 'images/placeholder.jpg' %}" alt="{{ related.title }}">
            {% endif %}
            <h3><a href="{% url 'blog:post_detail' related.slug %}">{{ related.title }}</a></h3>
            <p>{{ related.excerpt|truncatewords:10 }}</p>
        </article>
        {% endfor %}
    </div>
</section>
{% endif %}

<section class="comments-section">
    <h2>Comments ({{ comments_count }})</h2>

    {% if user.is_authenticated %}
    <form method="post" action="{% url 'blog:add_comment' post.slug %}" class="comment-form">
        {% csrf_token %}
        <textarea name="content" placeholder="Write your comment..." required></textarea>
        <button type="submit" class="btn btn-primary">Post Comment</button>
    </form>
    {% else %}
    <p class="login-prompt">
        <a href="{% url 'users:login' %}?next={{ request.path }}">Login</a> to leave a comment.
    </p>
    {% endif %}

    <div class="comments-list">
        {% for comment in comments %}
        <div class="comment" id="comment-{{ comment.id }}">
            <div class="comment-header">
                <strong>{{ comment.author.username }}</strong>
                <span class="comment-date">{{ comment.created_at|date:"M d, Y H:i" }}</span>
            </div>
            <div class="comment-content">
                {{ comment.content|linebreaks }}
            </div>

            {% if comment.replies.all %}
            <div class="replies">
                {% for reply in comment.replies.all %}
                <div class="comment reply">
                    <div class="comment-header">
                        <strong>{{ reply.author.username }}</strong>
                        <span class="comment-date">{{ reply.created_at|date:"M d, Y H:i" }}</span>
                    </div>
                    <div class="comment-content">
                        {{ reply.content|linebreaks }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if user.is_authenticated %}
            <button class="btn-reply" onclick="showReplyForm({{ comment.id }})">Reply</button>
            <form method="post" action="{% url 'blog:add_comment' post.slug %}" class="reply-form" id="reply-form-{{ comment.id }}" style="display: none;">
                {% csrf_token %}
                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                <textarea name="content" placeholder="Write your reply..." required></textarea>
                <button type="submit" class="btn btn-primary">Post Reply</button>
                <button type="button" class="btn btn-secondary" onclick="hideReplyForm({{ comment.id }})">Cancel</button>
            </form>
            {% endif %}
        </div>
        {% empty %}
        <p class="no-comments">No comments yet. Be the first to comment!</p>
        {% endfor %}
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
function showReplyForm(commentId) {
    document.getElementById('reply-form-' + commentId).style.display = 'block';
}

function hideReplyForm(commentId) {
    document.getElementById('reply-form-' + commentId).style.display = 'none';
}
</script>
{% endblock %}
